# PlainDesk v2

## Обзор проекта

PlainDesk — это интерактивная персонализируемая доска с виджетами, которая позволяет организовать ваше рабочее пространство по вашему усмотрению. Пользователи могут перетаскивать различные виджеты на доску, настраивать их и сохранять текущее состояние.


## Функциональность

- **Интерактивная доска** с сеткой для размещения виджетов
- **Drag-and-Drop** функциональность для виджетов
- **Система виджетов** с возможностью легкого расширения
- **Сохранение состояния** в localStorage браузера с возомжностью подключения nosql базы данных
- **Светлая и темная темы** с минималистичным дизайном
- **Настройки пользователя** и управление аккаунтом
- **Адаптивный дизайн** не требуется, только web версия

## План разработки версий

### Версия 0.3.0 - Базовая функциональность ✅ Реализовано
- Базовая структура проекта и настройка окружения
- Простая доска с сеткой для виджетов
- Базовый UI с минималистичным дизайном
- Настройка роутинга с использованием Next.js
- Базовый шаблон виджета (widget-template)
- Механизм добавления виджетов на доску
- Полная функциональность Drag & Drop
- Изменение размеров виджетов
- Удаление виджетов
- Панель элементов управления виджетами при наведении
- Базовые настройки для виджетов
- Светлая и темная темы
- Переключение между темами
- Первые базовые виджеты:
  - Календарь с отображением текущей даты
  - Часы с текущим временем
  - Простой список задач (Todo)
- Сохранение состояния доски в localStorage
- Сохранение расположения и размеров виджетов
- Сохранение настроек виджетов
- Автоматическое восстановление состояния при загрузке страницы
- Улучшенный дизайн виджетов с тенями и эффектами

### Версия 0.4.0 - Улучшение пользовательского интерфейса ⏳ Запланировано
- Плавные анимации при взаимодействии
- Улучшенная обратная связь при перетаскивании
- Оптимизация производительности
- Исправление багов и улучшение стабильности
- Улучшение базового шаблона виджетов
- Специфические настройки для каждого виджета

### Версия 0.5.0 - Расширение системы виджетов ⏳ Запланировано
- Добавление еще 3-5 новых виджетов:
  - Погода
  - Заметки
  - Таймер/секундомер
  - Календарь событий
  - RSS-лента
- Динамический импорт виджетов
- Улучшение системы настроек виджетов

### Версия 0.6.0 - Управление аккаунтом ⏳ Запланировано
- Регистрация и авторизация пользователей
- Профиль пользователя
- Основы системы сохранения настроек в облаке
- Подготовка к интеграции с NoSQL базой данных

### Версия 0.7.0 - Облачное хранение ⏳ Запланировано
- Интеграция с NoSQL базой данных
- Синхронизация между устройствами
- Резервное копирование настроек
- Возможность создания нескольких досок

### Версия 0.8.0 - Оптимизация и улучшения ⏳ Запланировано
- Оптимизация производительности
- Улучшение UX/UI
- Анимации и переходы с использованием Framer Motion
- Расширенные настройки виджетов

### Версия 1.0.0 - Релиз ⏳ Запланировано
- Финальное тестирование
- Исправление багов
- Документация для разработчиков виджетов
- Готовый к использованию продукт

### Версия 1.1.0+ - Будущие улучшения ⏳ Запланировано
- API для сторонних разработчиков виджетов
- Галерея виджетов сообщества
- Интеграции с внешними сервисами
- Расширенная аналитика использования доски

## Технический стек

1. **React** - основная библиотека для построения пользовательского интерфейса
2. **Next.js** - фреймворк для React с функциями серверного рендеринга и маршрутизации
3. **TypeScript** - типизированный суперсет JavaScript для более надежного кода
4. **Tailwind CSS** - утилитарный CSS-фреймворк для стилизации компонентов
5. **React DnD (Drag and Drop)** - библиотека для реализации функциональности перетаскивания виджетов
6. **Lucide React** - библиотека иконок для пользовательского интерфейса
7. **Framer Motion** - библиотека для создания анимаций в React-приложениях
8. **localStorage API** - для сохранения данных пользователя в браузере 
9. **Fetch API** - для выполнения HTTP-запросов к внешним API 
10. **CSS Grid и Flexbox** - для создания адаптивных макетов
11. **CSS Transitions и Animations** - для плавных переходов между состояниями интерфейса
12. **CSS Variables** - для управления темами (светлая/темная)
13. **Media Queries API** - для определения предпочтений пользователя по теме

## Архитектура

### Система виджетов

PlainDesk использует модульную систему виджетов, которая позволяет легко расширять функциональность доски:

- Все виджеты хранятся в одной директории (`widgets/`)
- Каждый виджет наследуется от базового класса/компонента (`widget-template`)
- Базовый класс обеспечивает:
  - Управление состоянием виджета и сохранение состояния при изменении
  - Обработку конфигурации и настроек
  - Рендеринг пользовательского интерфейса
  - Специфическую для виджета функциональность
  - Обработку скриптов виджета (опционально)
- Меню добавления виджетов автоматически получает список доступных виджетов через динамический импорт
- Приложение взаимодействует с виджетами через общий интерфейс базового класса, что обеспечивает гибкость и простоту добавления новых виджетов без модификации основной логики приложения

### Главные компоненты

- **Доска** - основной контейнер, который содержит сетку и виджеты
- **Заголовок** - содержит элементы управления доской и настройки
- **Сетка** - область для размещения виджетов
- **Виджеты** - отдельные функциональные блоки, которые можно размещать на доске

### Дизайн и поведение виджетов

#### Внешний вид
- **Минималистичный дизайн** - чистый интерфейс без лишних элементов
- **Скругленные края** для всех виджетов
- **Аккуратное размещение** строго по сетке, тень справа и снизу очень лёгкая
- **Акцентный цвет** - #A855F7 (фиолетовый) используется для кнопок, активных элементов и выделения


#### Элементы управления
Каждый виджет имеет следующие элементы управления, которые появляются **только при наведении курсора**:
- **Ручка перетаскивания** - для перемещения виджета по доске
- **Кнопка удаления** - для удаления виджета с доски
- **Элемент изменения размера** - для изменения габаритов виджета
- **Меню настроек** - для настройки специфичных параметров виджета

Когда курсор не наведен на виджет, все элементы управления скрыты, обеспечивая чистый и неперегруженный интерфейс.

#### Размещение и перемещение
- **Добавление виджета**: При нажатии на кнопку "+" появляется меню выбора виджетов
- **Размещение виджета**: После выбора, виджет "приклеивается" к курсору мыши, ожидая размещения пользователем
- **Плавное перетаскивание** с анимацией для комфортного взаимодействия
- **Свободное позиционирование**: Виджеты могут накладываться друг на друга
- **Границы размещения**: Виджеты не могут выходить за пределы экрана влево и вверх, но могут расширяться вправо и вниз

## Разработка новых виджетов

Для создания нового виджета:

1. Создайте новый файл в директории `widgets/` с именем, соответствующим типу виджета (например, `CalendarWidget.tsx` для виджета типа "calendar")
2. Определите манифест виджета, который описывает его метаданные
3. Реализуйте компонент виджета, используя интерфейс `WidgetProps`
4. Зарегистрируйте манифест виджета в файле `widgets/index.ts`

### Пошаговая инструкция по добавлению нового виджета

1. **Создание файла виджета**:
   ```typescript
   // widgets/CalendarWidget.tsx
   "use client"

   import { useState, useEffect } from 'react';
   import type { Widget, WidgetManifest } from '@/types/Widget';
   import { WidgetProps } from './widget-template';

   // Манифест виджета календаря
   export const CALENDAR_WIDGET_MANIFEST: WidgetManifest = {
     id: 'calendar',
     name: 'Календарь',
     description: 'Виджет для отображения календаря',
     minSize: { width: 200, height: 200 },
     maxSize: { width: 500, height: 500 },
     defaultSize: { width: 300, height: 300 }
   };

   const CalendarWidget: React.FC<WidgetProps> = ({
     widget,
     updateWidget,
     removeWidget,
     isDarkMode = false,
   }) => {
     // При первом рендеринге устанавливаем минимальный и максимальный размер
     useEffect(() => {
       if (updateWidget && (!widget.minSize || !widget.maxSize)) {
         updateWidget({
           ...widget,
           minSize: CALENDAR_WIDGET_MANIFEST.minSize,
           maxSize: CALENDAR_WIDGET_MANIFEST.maxSize
         });
       }
     }, [widget, updateWidget]);

     // Реализация виджета...
     return (
       <div className="p-4 flex flex-col h-full">
         {widget.title && (
           <div className="text-lg font-medium mb-2">{widget.title}</div>
         )}
         <div className="flex-1 flex items-center justify-center">
           Календарь
         </div>
       </div>
     );
   };

   export default CalendarWidget;
   ```

2. **Регистрация манифеста виджета**:
   ```typescript
   // widgets/index.ts
   import { WidgetManifest } from '@/types/Widget';
   import { DEFAULT_WIDGET_MANIFEST } from './widget-template';
   import { TEXT_WIDGET_MANIFEST } from './TextWidget';
   import { CALENDAR_WIDGET_MANIFEST } from './CalendarWidget'; // Импортируем манифест нового виджета

   // Регистрируем все манифесты виджетов
   export const widgetManifests: WidgetManifest[] = [
     TEXT_WIDGET_MANIFEST,
     CALENDAR_WIDGET_MANIFEST, // Добавляем манифест нового виджета
     // Добавьте здесь манифесты других виджетов
   ];

   // ... остальной код ...
   ```

### Структура манифеста виджета

Каждый виджет должен определять свой манифест, который содержит следующие поля:

- `id`: Уникальный идентификатор типа виджета
- `name`: Отображаемое имя виджета
- `description`: Описание виджета
- `minSize`: Минимальный размер виджета
- `maxSize`: Максимальный размер виджета
- `defaultSize`: Размер виджета по умолчанию
- `icon`: Иконка виджета (опционально)

### Важные замечания

1. **Имя файла виджета** должно соответствовать его типу с заглавной буквы и суффиксом "Widget" (например, `TextWidget.tsx` для типа "text")
2. **Манифест виджета** должен быть экспортирован из файла виджета
3. **Манифест виджета** должен быть зарегистрирован в файле `widgets/index.ts`
4. **Компонент виджета** должен использовать интерфейс `WidgetProps` из `widget-template.tsx`
5. **Компонент виджета** должен устанавливать минимальный и максимальный размер при первом рендеринге

## Процесс внедрения нового виджета

1. **Создание файла виджета**:
   - Создайте новый файл в директории `widgets/` с именем, соответствующим функциональности (например, `WeatherWidget.tsx`)
   - Импортируйте базовый шаблон виджета

2. **Определение структуры данных**:
   - Опишите интерфейс для параметров и состояния виджета
   - Определите начальное состояние

3. **Реализация логики**:
   - Разработайте основную функциональность виджета
   - Настройте взаимодействие с внешними API, если необходимо
   - Создайте механизм сохранения и восстановления состояния

4. **Разработка интерфейса**:
   - Придерживайтесь минималистичного дизайна
   - Убедитесь, что виджет адаптируется к различным размерам
   - Реализуйте специфичные настройки

5. **Тестирование**:
   - Проверьте функциональность виджета
   - Убедитесь, что состояние корректно сохраняется и восстанавливается
   - Протестируйте перетаскивание и изменение размера

## Лицензия

MIT 

## Система сохранения состояния

PlainDesk использует двухуровневую систему хранения данных:
1. **Локальное хранилище (localStorage)** - для быстрого доступа и работы в офлайн-режиме
2. **Облачное хранилище (NoSQL БД)** - для синхронизации между устройствами и резервного копирования (будет реализовано позже)

### Структура данных

Данные в localStorage организованы в виде JSON-объектов со следующей структурой:

```javascript
{
  "board": {
    "id": "default",
    "lastUpdated": 1678453267890,
    "settings": {
      "theme": "light",
      "gridSize": 20,
      // Другие настройки доски
    }
  },
  "widgets": {
    "widget_1678453267890": {
      "id": 1678453267890,
      "type": "text",
      "position": { "x": 20, "y": 20 },
      "size": { "width": 240, "height": 160 },
      "minSize": { "width": 120, "height": 100 },
      "maxSize": { "width": 600, "height": 400 },
      "title": "Заметки",
      "content": { "text": "Содержимое заметки" },
      "settings": { "fontSize": "medium" },
      "lastUpdated": 1678453267890
    },
    // Другие виджеты
  }
}
```

### Ключи в localStorage

Для разделения данных и обеспечения возможности работы с несколькими досками используются следующие ключи:

- `plaindesk_board_{boardId}` - настройки доски с указанным ID
- `plaindesk_widgets_{boardId}` - виджеты, принадлежащие доске с указанным ID
- `plaindesk_user` - пользовательские настройки (тема, предпочтения и т.д.)
- `plaindesk_meta` - метаданные (список досок, информация о синхронизации и т.д.)

### Процесс сохранения данных

1. **Автоматическое сохранение**:
   - При изменении состояния доски или виджетов
   - При добавлении или удалении виджетов
   - При изменении настроек
   - Периодически (каждые 30 секунд)

2. **Дебаунсинг**:
   - Для предотвращения частых операций записи используется механизм дебаунсинга
   - Изменения накапливаются и записываются пакетом после короткой задержки (300 мс)

3. **Перед закрытием страницы**:
   - Сохранение всех несохраненных изменений при событии `beforeunload`

### Процесс загрузки данных

1. **При инициализации приложения**:
   - Загрузка настроек пользователя
   - Загрузка метаданных
   - Загрузка настроек текущей доски
   - Загрузка виджетов текущей доски

2. **Обработка отсутствующих данных**:
   - Если данные не найдены, используются значения по умолчанию
   - Создается новая доска с базовыми настройками

### Управление жизненным циклом данных

1. **Добавление виджета**:
   - Создание записи в объекте `widgets`
   - Обновление метки времени `lastUpdated`
   - Сохранение в localStorage

2. **Обновление виджета**:
   - Обновление соответствующей записи в объекте `widgets`
   - Обновление метки времени `lastUpdated`
   - Сохранение в localStorage

3. **Удаление виджета**:
   - Удаление записи из объекта `widgets`
   - Обновление метки времени `lastUpdated` доски
   - Сохранение в localStorage

### Интеграция с базовым шаблоном виджетов

Система сохранения состояния интегрирована с базовым шаблоном виджетов (`widget-template.tsx`) следующим образом:

1. **Базовый шаблон предоставляет**:
   - Методы для сохранения состояния виджета
   - Методы для загрузки состояния виджета
   - Обработчики событий изменения состояния

2. **Каждый виджет**:
   - Наследует базовые методы сохранения/загрузки
   - Может переопределить их для специфических нужд
   - Вызывает методы сохранения при изменении своего состояния

3. **Доска**:
   - Координирует сохранение всех виджетов
   - Управляет общим состоянием (расположение, размеры)
   - Обеспечивает согласованность данных

### Подготовка к интеграции с NoSQL БД

Структура данных и механизмы сохранения спроектированы с учетом будущей интеграции с NoSQL базой данных:

1. **Уникальные идентификаторы**:
   - Каждый объект имеет уникальный ID
   - Используются временные метки для отслеживания изменений

2. **Атомарные операции**:
   - Каждое изменение можно представить как атомарную операцию
   - Поддерживается частичное обновление объектов

3. **Разрешение конфликтов**:
   - Метки времени `lastUpdated` позволяют определить более новую версию
   - Структура данных позволяет выполнять трехстороннее слияние

4. **Абстракция хранилища**:
   - Операции с данными выполняются через абстрактный интерфейс
   - Конкретная реализация (localStorage или NoSQL БД) скрыта за этим интерфейсом

### Сервисы для работы с данными

Для работы с данными используются следующие сервисы:

1. **StorageService**:
   - Абстрактный интерфейс для операций с хранилищем
   - Реализации для localStorage и будущей NoSQL БД

2. **BoardService**:
   - Управление состоянием доски
   - Операции с виджетами (добавление, удаление, обновление)

3. **WidgetService**:
   - Управление состоянием отдельных виджетов
   - Загрузка и сохранение специфичных для виджета данных

4. **SyncService** (будет реализован позже):
   - Синхронизация между localStorage и NoSQL БД
   - Разрешение конфликтов
   - Управление сетевыми запросами

### Обработка ошибок и восстановление

1. **Проверка целостности данных**:
   - При загрузке проверяется структура и валидность данных
   - Поврежденные данные восстанавливаются из резервной копии или заменяются значениями по умолчанию

2. **Квоты localStorage**:
   - Отслеживание размера данных
   - Предупреждение пользователя при приближении к лимиту
   - Автоматическая очистка устаревших данных

3. **Резервное копирование**:
   - Периодическое создание резервных копий в localStorage
   - Возможность экспорта/импорта данных (будет реализовано позже)

### Безопасность данных

1. **Изоляция данных**:
   - Данные разных пользователей хранятся отдельно
   - Используются префиксы для предотвращения конфликтов с другими приложениями

2. **Защита от XSS**:
   - Санитизация данных перед сохранением
   - Проверка данных при загрузке

3. **Приватность**:
   - Чувствительные данные не сохраняются в localStorage
   - Подготовка к шифрованию данных в будущих версиях 